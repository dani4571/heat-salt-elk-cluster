heat_template_version: 2013-05-23

description: Child stack for salt minions.

parameters:
  stack-prefix:
    type: string
    description: String generated by parent stack to ease naming.
    default: ''
  private_key:
    type: string
    description: Private key used to talk to other instances in same stack.
  public_key:
    type: string
    description: Public key used to talk to other instances in same stack.
  flavor:
    type: string
    description: Flavor to use
  image:
    type: string
    description: Image name
  network:
    type: string
    description: Network to use with minion
  master:
    type: string
    description: Salt-master location
  minion-config:
    type: string
    description: minion software config
  minion-roles:
    type: string
    description: List of roles for the minion
  floating-network-id:
    type: string
    description: UUID of the external network. The private network created by this stack will route to this network. Also any floating ip's needed by this stack will come this network. 

resources:

  stack-string:
    type: OS::Heat::RandomString
    properties:
      length: 6
      sequence: lettersdigits

  deploy-salt-minion:
    type: OS::Heat::SoftwareDeployment
    properties:
      input_values:
        public_key:
          get_param: public_key
        master:
          get_param: master
      config:
        get_param: minion-config
      server:
        get_resource: minion 

  minion-ip:
    type: OS::Neutron::FloatingIP
    properties:
      floating_network_id: 
        get_param: floating-network-id

  minion-port:
    type: OS::Neutron::Port
    properties:
      network_id: 
        get_resource: net


  minion-floating-ip-ass: 
    type: OS::Neutron::FloatingIPAssociation
    properties: 
      floatingip_id:
        get_resource: minion-ip
      port_id:
        get_resource: minion-port

  minion:
    type: OS::Nova::Server
    properties:

      name:
        str_replace:
          template: $stackprefix-$stackstr
          params:
            $stackprefix:
              get_param: stack-prefix
            $stackstr:
              get_attr:
                - stack-string
                - value

      image: 
        get_param: image

      flavor:
        get_param: flavor

      personality:
        /root/.ssh/coms_rsa:
          get_param: private_key
        /etc/salt/grains:
          str_replace:
            template: "roles: [$roles]"
            params:
              $roles:
                get_param: minion-roles

      networks:
        - port:
            get_resource: minion-port

      user_data_format: SOFTWARE_CONFIG

outputs:
  minion-ip:
    value:
      get_attr:
        - minion
        - first_address
  minion-stdout:
    value:
      get_attr:
        - deploy-salt-minion
        - deploy_stdout
  minion-stderr:
    value:
      get_attr:
        - deploy-salt-minion
        - deploy_stderr
